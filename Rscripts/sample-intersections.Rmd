```{r}
source("Rscripts/utils.R")
library(valr)
setwd("~/projects/phased-fdr-and-peaks/")
getwd()
```

```{r}
# run scripts/fire-correlations.sh
comparisons=my_read_bed("Tables/fire-correlations.tbl.gz") %>%
    mutate(
        bin = round(GM12878),
        dnase_bin = round(10*log2(DNase))
        ) 

comparisons  
```

```{r}
z=comparisons %>% 
    #group_by(bin) %>% mutate(row=seq(n())) %>% filter(row<10000) %>%
    pivot_longer(
        c("GM12878", "PS00356")
    ) %>%
    arrange(name)%>%
    mutate(name=factor(name, levels=rev(unique(name)))) %>%
    ggplot(aes(x=PS00388, y=value)) +
    geom_hex(bins=50) + scale_fill_distiller("", palette = "Spectral", trans="log10") +
    stat_cor(size=2.5)+
    scale_x_continuous("FIRE score of PS00388") + 
    scale_y_continuous("FIRE score") + 
    facet_row(~name,    strip.position = "left") + 
    my_grid() 
my_ggsave("Figures/FIRE-peak-corelation.pdf", height=3, width=7)
```

```{r}

logit_e = function(x, a=1, b=0) {
    z=x**exp(1)
    log(z/(1-z))
}


anti_logit_e = function(x, a=1, b=0) {
    z=exp(b)*x**a
    (z/(1+z))**exp(-1)
}

trans_anti_logit_e <- trans_new(
  name      = "trans_anti_logit_e",
  transform = anti_logit_e,
  inverse   = logit_e,
  #domain    = c(-Inf, Inf)
)

data="Tables/DNase-peaks-vs-percent-fire.bed.gz"
d=fread(data)
colnames(d) = c("chrom", "start", "end", "DNase", "GM12878")
min(d$DNase)
max(d$DNase)
z=d %>%
    filter(chrom != "chrX", chrom != "chrY") %>%
    mutate(
        #DNase=anti_logit_e(DNase, a=1.75, b=-2)
    ) %>%
    ggplot(aes(x=DNase, y=GM12878)) +
    geom_hex(bins=50) + scale_fill_distiller("", palette = "Spectral", trans="log10") +
    stat_cor(size=2.5)+
    #geom_smooth(se=F, method="lm", color="black", linetype="dashed")+
    scale_x_continuous("DNase peak signal", trans="log10") + 
    scale_y_continuous("% actuation in Fiber-seq data", label=percent) + 
    annotation_logticks(side="b") + 
    my_grid() 
#zz=z+geom_xsidedensity(aes(y=stat(density))) + geom_ysidedensity(aes(x=stat(density))) 
my_ggsave("Figures/DNase-peaks-vs-percent-fire.pdf", height=2, width=2.75)
```
